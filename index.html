<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Game UI Editor Pro</title>
  <style>
    :root {
      --bg-dark: #020617;
      --bg-panel: #0f172a;
      --border: #1e293b;
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --accent-primary: #38bdf8; /* Sky blue */
      --accent-secondary: #818cf8; /* Indigo */
      --success: #10b981;
      --danger: #ef4444;
      --glass: rgba(15, 23, 42, 0.7);
    }

    * { box-sizing: border-box; outline: none; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Inter, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-dark);
      /* Professional Dark Radial Background */
      background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 70%);
      color: var(--text-main);
      overflow: hidden; /* Prevent body scroll, let container scroll */
    }

    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      gap: 15px;
      overflow-y: auto;
    }

    /* Header & Toolbar */
    .header {
      width: 100%;
      max-width: 1280px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 0 10px;
      /* --- FIX: Added z-index to ensure dropdown is on top --- */
      position: relative;
      z-index: 500; 
    }

    .toolbar {
      display: flex;
      gap: 10px;
      background: var(--glass);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .btn {
      padding: 10px 18px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
      background: linear-gradient(180deg, #1e293b, #0f172a);
      color: var(--text-muted);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn:hover {
      background: #334155;
      color: #fff;
      transform: translateY(-1px);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: #0f172a;
      border: none;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
    }
    
    .btn.primary:hover {
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
    }

    /* Dropdown */
    .dropdown { position: relative; }
    .dropdown-content {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      flex-direction: column;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
      /* Increased z-index just to be safe */
      z-index: 1000; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      min-width: 200px;
    }
    .dropdown:hover .dropdown-content { display: flex; }
    .dropdown-content button {
      background: transparent;
      border: none;
      text-align: left;
      width: 100%;
      border-radius: 0;
      box-shadow: none;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .dropdown-content button:hover { background: rgba(255,255,255,0.05); }

    /* Main Layout */
    .canvasWrap {
      width: 100%;
      max-width: 1280px;
      display: grid;
      grid-template-columns: 1fr 320px; /* Split view */
      gap: 20px;
      height: 100%;
      min-height: 0; /* Flexbox fix */
      /* Ensure canvas layer is lower than header */
      position: relative;
      z-index: 1;
    }

    /* Canvas Area with CSS Grid Pattern */
    .canvas {
      width: 100%;
      aspect-ratio: 16/9; /* Standard Game Ratio */
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      background-color: #0b1121;
      /* CSS Pattern Grid */
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), 
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 32px 32px;
    }
    
    /* Center lines for the canvas to look like an editor */
    .canvas::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: 
        linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
      background-size: 50% 50%; /* Crosshair center */
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Right Side Panel */
    .panel {
      background: var(--bg-panel);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
    }

    .chat-container {
      background: #020617;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
      padding: 10px;
      height: 250px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
    }

    .textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0b1121;
      color: var(--text-main);
      resize: none;
      font-family: inherit;
    }
    .textarea:focus { border-color: var(--accent-primary); }

    .sendRow { display: flex; justify-content: flex-end; }

    /* Draggable Elements Styling */
    .element {
      position: absolute;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      user-select: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      overflow: hidden;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
      letter-spacing: 0.5px;
      cursor: grab;
      backdrop-filter: blur(4px);
      z-index: 10; /* Base z-index for elements */
    }

    .element:active { cursor: grabbing; border-color: #fff; z-index: 50; }

    /* Specific Element Colors (Gradients) */
    .grid { background: linear-gradient(135deg, rgba(37,99,235,0.8), rgba(29, 78, 216, 0.9)); }
    
    .play_button { background: linear-gradient(135deg, #10b981, #059669); }
    .auto_play_button { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    
    .increase_bet, .increase_level { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .decrease_bet, .decrease_level { background: linear-gradient(135deg, #f97316, #ea580c); }
    
    .max_bet_button { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    .min_bet_button { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    
    .win_label { background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 8px; }
    
    .sprite { 
      background: rgba(255,255,255,0.1); 
      border: 1px dashed rgba(255,255,255,0.4); 
      color: #fff;
    }
    
    .label { 
      background: transparent; 
      border: 1px dotted rgba(255,255,255,0.3);
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    /* Resize Handle */
    .handle {
      position: absolute;
      right: 2px;
      bottom: 2px;
      width: 10px;
      height: 10px;
      background: rgba(255,255,255,0.5);
      clip-path: polygon(100% 0, 100% 100%, 0 100%);
      cursor: se-resize;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .element:hover .handle { opacity: 1; }

    /* Info Badge */
    .badge {
      position: absolute;
      transform: translate(0, -100%);
      top: -5px;
      left: 0;
      background: rgba(0,0,0,0.8);
      color: var(--accent-primary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-family: monospace;
      z-index: 100;
      pointer-events: none;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Context Menu */
    .context {
      position: absolute;
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 2000; /* Very high z-index */
      min-width: 240px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    .context .row { display: flex; gap: 8px; align-items: center; }
    .context label { font-size: 11px; color: var(--text-muted); width: 40px; text-transform: uppercase; font-weight: bold; }
    .context input {
      flex: 1;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0f172a;
      color: #fff;
      font-size: 12px;
    }
    .context .actions { display: flex; gap: 8px; justify-content: space-between; margin-top: 5px; }
    .context button {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }
    #btnDelete { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    #btnDelete:hover { background: rgba(239, 68, 68, 0.4); }
    #btnApply { background: var(--accent-primary); color: #020617; }
    #btnApply:hover { background: #0ea5e9; }

    /* Progress & Footer */
    #progressContainer {
      width: 100%;
      height: 6px;
      background: #1e293b;
      margin-top: 10px;
      border-radius: 3px;
      overflow: hidden;
      display: none;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: var(--success);
      transition: width 0.3s ease;
    }
    #links { display: none; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
    #links a {
      color: var(--accent-primary);
      text-decoration: none;
      font-size: 13px;
      background: rgba(255,255,255,0.03);
      padding: 8px;
      border-radius: 6px;
      display: block;
      text-align: center;
      transition: background 0.2s;
    }
    #links a:hover { background: rgba(255,255,255,0.08); }

    .footer { font-size: 11px; color: var(--text-muted); margin-top: auto; opacity: 0.5; }

    /* Mobile Responsive */
    @media (max-width: 900px) {
      .canvasWrap { grid-template-columns: 1fr; }
      .canvas { aspect-ratio: 1/1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="toolbar">
        <button class="btn" id="addGrid">Add Grid</button>
        <div class="dropdown">
          <button class="btn">Add Component â–¾</button>
          <div class="dropdown-content">
            <button data-type="play_button">Play Button</button>
            <button data-type="increase_bet">Increase Bet (+)</button>
            <button data-type="decrease_bet">Decrease Bet (-)</button>
            <button data-type="auto_play_button">Auto Play</button>
            <button data-type="max_bet_button">Max Bet</button>
            <button data-type="min_bet_button">Min Bet</button>
            <button data-type="increase_level">Level Up</button>
            <button data-type="decrease_level">Level Down</button>            
          </div>
        </div>
        <button class="btn" id="addWin">Win Label</button>
        <button class="btn" id="addLabel">Text Label</button>
        <button class="btn" id="addSprite">Sprite Box</button>
      </div>
    </div>

    <div class="canvasWrap">
      <div id="canvas" class="canvas">
        </div>
      
      <div class="panel">
        <h3 style="margin:0; font-size:14px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">AI Assistant</h3>
        <div id="chatBox" class="chat-container">
           <div style="color:var(--text-muted); font-style:italic;">System ready. Add elements or ask AI to generate config...</div>
        </div>
        <textarea id="msgInput" class="textarea" placeholder="Describe how the game logic should work..."></textarea>
        
        <div id="waitMessage" style="display:none; color:var(--accent-secondary); font-size:12px; margin-top:5px;">Processing...</div>
        
        <div id="progressContainer">
          <div id="progressFill"></div>
        </div>
        
        <div class="sendRow">
          <button class="btn primary" id="send">Generate Code</button>
        </div>

        <div id="links" style="display:none;">
          <a id="playLink" href="#" target="_blank">â–¶ Play Game</a>
          <a id="downloadLink" href="#" target="_blank">â¬‡ Download Files</a>
          <a id="downloadAnalysis" href="#" target="_blank">ðŸ“Š View Analysis</a>
        </div>
      </div>
    </div>

    <div class="footer">Coordinate System: 0..1024 | Design Mode Active</div>
  </div>

  <div id="contextMenu" class="context">
    <div style="font-size:12px; font-weight:bold; color:#fff; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px;">Properties</div>
    <div class="row"><label>X</label><input id="ctxX" type="number"/></div>
    <div class="row"><label>Y</label><input id="ctxY" type="number"/></div>
    <div class="row"><label>W</label><input id="ctxW" type="number"/></div>
    <div class="row"><label>H</label><input id="ctxH" type="number"/></div>
    <div class="row" id="textRow"><label>TXT</label><input id="ctxText" placeholder="Label text..."/></div>
    <div class="actions">
      <button id="btnDelete">Delete</button>
      <button id="btnApply">Update</button>
    </div>
  </div>

<script>
/* LOGIC REMAINS UNCHANGED - JUST UI UPDATE 
*/
const canvas = document.getElementById('canvas');
const contextMenu = document.getElementById('contextMenu');
const url = "https://hamster-teaching-serval.ngrok-free.app";
const session_id = "user_" + Math.floor(Math.random() * 1000000);
const sendButton = document.getElementById('send');

const ctxX = document.getElementById('ctxX'),
      ctxY = document.getElementById('ctxY'),
      ctxW = document.getElementById('ctxW'),
      ctxH = document.getElementById('ctxH'),
      ctxText = document.getElementById('ctxText'),
      textRow = document.getElementById('textRow');

const elements = {
  grid: null,
  play_button: null,
  increase_bet: null,
  decrease_bet: null,
  auto_play_button: null,
  max_bet_button: null,
  min_bet_button: null,
  increase_level: null,
  decrease_level: null,  
  win_label: null,
  labels: [],
  sprites: [] 
};  

function updateFontSize(el) {
  const w = el.offsetWidth;
  const h = el.offsetHeight;
  // Adjusted font logic for cleaner look
  let size = Math.min(h * 0.4, w / (el.textContent.length || 1) * 1.5);
  size = Math.max(10, size); // Minimum size
  el.style.fontSize = size + "px";
  // Center vertically nicely
  el.style.display = "flex";
  el.style.alignItems = "center";
  el.style.justifyContent = "center";
}

let current = null;

function create(type) {
  if (type !== 'label' && type !== 'sprite' && elements[type]) return;

  const el = document.createElement('div');
  el.className = 'element ' + (type === 'label' ? 'label' : type);
  // Default sizes
  el.style.width = '140px';
  el.style.height = '50px';
  el.style.left = '50px';
  el.style.top = '50px';
  el.dataset.type = type;

  if (type === 'label' || type === 'sprite') {
    const span = document.createElement('span');
    span.textContent = type === 'label' ? 'New Label' : 'Sprite';
    el.appendChild(span);
  } else {
    // Cleaner text formatting
    el.textContent = type.replace(/_/g, ' ').toUpperCase();
    updateFontSize(el);
  }

  const handle = document.createElement('div');
  handle.className = 'handle';
  el.appendChild(handle);

  canvas.appendChild(el);
  if (type === 'label') elements.labels.push(el);
  else if (type === 'sprite') elements.sprites.push(el);
  else elements[type] = el;

  attach(el, handle);
}

function attach(el, handle) {
  el.addEventListener('mousedown', startDrag);
  handle.addEventListener('mousedown', startResize);
  handle.addEventListener('mouseenter', () => showBadge(el));
  handle.addEventListener('mouseleave', () => hideBadge(el));
  el.addEventListener('contextmenu', e => {
    e.preventDefault();
    current = el;
    openContext(e.pageX, e.pageY);
  });
}

function getPos(el) {
  const r = el.getBoundingClientRect(),
        p = canvas.getBoundingClientRect();
  return {
    x: Math.round(r.left - p.left),
    y: Math.round(r.top - p.top),
    width: Math.round(r.width),
    height: Math.round(r.height)
  };
}

function showBadge(el) {
  if (el._badge) return updateBadge(el);
  const b = document.createElement('div');
  b.className = 'badge';
  el._badge = b;
  el.appendChild(b);
  updateBadge(el);
}

function updateBadge(el) {
  const d = getPos(el);
  el._badge.textContent = `X:${d.x} Y:${d.y} [${d.width}x${d.height}]`;
}

function hideBadge(el) {
  if (el._badge) { el._badge.remove(); el._badge = null; }
}

function startDrag(e) {
  if (e.target.classList.contains('handle')) return;
  e.preventDefault();
  const el = this;
  const rect = el.getBoundingClientRect(),
        p = canvas.getBoundingClientRect();
  const startX = e.clientX,
        startY = e.clientY;
  const origX = rect.left - p.left,
        origY = rect.top - p.top;

  // Bring to front
  el.style.zIndex = 50;

  function move(ev) {
    const nx = Math.max(0, Math.min(origX + ev.clientX - startX, canvas.clientWidth - el.offsetWidth));
    const ny = Math.max(0, Math.min(origY + ev.clientY - startY, canvas.clientHeight - el.offsetHeight));
    el.style.left = nx + 'px';
    el.style.top = ny + 'px';
    if (el._badge) updateBadge(el);
  }

  function up() { 
    el.style.zIndex = 10; // Return to normal base z-index
    document.removeEventListener('mousemove', move); 
    document.removeEventListener('mouseup', up); 
  }

  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
}

function startResize(e) {
  e.stopPropagation(); e.preventDefault();
  const el = this.parentElement;
  el._resizing = true;
  const startX = e.clientX,
        startY = e.clientY,
        startW = el.offsetWidth,
        startH = el.offsetHeight;

  function move(ev) {
    let rawLeft = parseInt(el.style.left) || el.offsetLeft;
    let rawTop = parseInt(el.style.top) || el.offsetTop;
    let nw = Math.max(24, Math.min(startW + ev.clientX - startX, canvas.clientWidth - rawLeft));
    let nh = Math.max(24, Math.min(startH + ev.clientY - startY, canvas.clientHeight - rawTop));
    el.style.width = nw + 'px';
    el.style.height = nh + 'px';
    if (!['label','sprite'].includes(el.dataset.type)) updateFontSize(el);
    if (el._badge) updateBadge(el);
  }
  function up() { el._resizing = false; document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); }
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
}

function openContext(pageX, pageY) {
  const d = getPos(current);
  ctxX.value = d.x; ctxY.value = d.y; ctxW.value = d.width; ctxH.value = d.height;
  const isTextType = ['label', 'sprite'].includes(current.dataset.type);
  textRow.style.display = isTextType ? 'flex' : 'none';
  
  if(isTextType) {
      ctxText.value = current.firstElementChild ? current.firstElementChild.textContent : '';
  }

  // Adjust menu position so it doesn't go off screen
  const menuW = 240, menuH = 300;
  let left = pageX;
  let top = pageY;
  if (left + menuW > window.innerWidth) left = window.innerWidth - menuW - 20;
  if (top + menuH > window.innerHeight) top = window.innerHeight - menuH - 20;

  contextMenu.style.left = left + 'px'; 
  contextMenu.style.top = top + 'px';
  contextMenu.style.display = 'flex';
}

document.getElementById('btnApply').addEventListener('click', () => {
  if (!current) return;
  const nx = Number(ctxX.value)||0, ny = Number(ctxY.value)||0, nw = Math.max(8,Number(ctxW.value)||8), nh = Math.max(8,Number(ctxH.value)||8);
  const c = canvas.getBoundingClientRect();
  // We allow going slightly out of bound on apply manually if needed, or strictly clamp? Let's strictly clamp for safety
  // if (nx+nw>c.width || ny+nh>c.height) { alert("Values exceed boundary"); return; }
  
  current.style.left = nx+'px'; current.style.top = ny+'px'; current.style.width = nw+'px'; current.style.height = nh+'px';
  
  if(['label','sprite'].includes(current.dataset.type)){
     if(current.firstElementChild) current.firstElementChild.textContent = ctxText.value;
  } else {
     updateFontSize(current);
  }
  contextMenu.style.display='none'; hideBadge(current);
});

document.getElementById('btnDelete').addEventListener('click', () => {
  if (!current) return;
  const t = current.dataset.type;
  current.remove();

  if (t === 'label') {
    const i = elements.labels.indexOf(current);
    if (i > -1) elements.labels.splice(i, 1);
  } else if (t === 'sprite') {
    const i = elements.sprites.indexOf(current);
    if (i > -1) elements.sprites.splice(i, 1);
  } else {
    elements[t] = null;
  }

  contextMenu.style.display = 'none';
});

document.addEventListener('click', e=>{if(!contextMenu.contains(e.target)) contextMenu.style.display='none';});

document.getElementById('addGrid').addEventListener('click', ()=>create('grid'));
document.querySelectorAll('.dropdown-content button').forEach(b => b.addEventListener('click', ()=>create(b.dataset.type)));
document.getElementById('addWin').addEventListener('click', ()=>create('win_label'));
document.getElementById('addLabel').addEventListener('click', ()=>create('label'));
document.getElementById('addSprite').addEventListener('click', ()=>create('sprite'));

canvas.addEventListener('mousemove', e=>{
  [...canvas.querySelectorAll('.element')].forEach(el=>{
    const rect = el.getBoundingClientRect(), hx = rect.right-6, hy = rect.bottom-6; // Handle is smaller now
    // Simple hover detection is handled by CSS mostly now, but this keeps badge logic
    if(!el.matches(':hover') && !el._resizing) hideBadge(el);
  });
});

function collectPayload() {
  const payload = {};
  const c = canvas.getBoundingClientRect();
  function to1024(v, axis){ return Math.round(v/(axis===0?c.width:c.height)*1024); }

  for (const k in elements) {
    if (k === 'labels' || k === 'sprites') continue;
    const el = elements[k];
    if (!el) continue;
    const d = getPos(el);
    payload[k] = { x: to1024(d.x,0), y: to1024(d.y,1), width: to1024(d.width,0), height: to1024(d.height,1) };
  }

  payload.Labels = elements.labels.map(l => {
      const d = getPos(l);
      return { x: to1024(d.x,0), y: to1024(d.y,1), width: to1024(d.width,0), height: to1024(d.height,1), text: l.firstElementChild ? l.firstElementChild.textContent : '' };
  });

  payload.Sprites = elements.sprites.map(s => {
      const d = getPos(s);
      return { x: to1024(d.x,0), y: to1024(d.y,1), width: to1024(d.width,0), height: to1024(d.height,1), text: s.firstElementChild ? s.firstElementChild.textContent : '' };
  });

  payload.message = document.getElementById('msgInput').value;
  return payload;
}

sendButton.addEventListener('click', ()=>{
  const payload = collectPayload();
  document.getElementById("waitMessage").style.display="block";
  
  fetch(`${url}/receive_message`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ session_id, rects: payload })
  })
  .then(res=>res.json())
  .then(data=>{
    document.getElementById("waitMessage").style.display="none";
    if (data.status === "True") {
      const chatBox = document.getElementById("chatBox");
      const userMsg = document.createElement("div");
      userMsg.style.marginBottom = "8px";
      userMsg.innerHTML = `<span style="color:#94a3b8; font-weight:bold;">You:</span> ${payload.message}`;
      chatBox.appendChild(userMsg);
      
      const botMsg = document.createElement("div");
      botMsg.innerHTML = `<span style="color:#38bdf8; font-weight:bold;">Bot:</span> ${data.reply}`;
      botMsg.style.marginBottom = "15px";
      botMsg.style.paddingLeft = "10px";
      botMsg.style.borderLeft = "2px solid #38bdf8";
      chatBox.appendChild(botMsg);
      chatBox.scrollTop = chatBox.scrollHeight;
    } else {
      console.error("Error:", data.reply);
    }
  })
  .catch(err=>{ console.error(err); document.getElementById("waitMessage").style.display="none"; });
});

function checkStatus(){
  fetch(`${url}/get_status`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ session_id })
  })
  .then(res=>res.json())
  .then(data=>{
    const percent = data.process_percent||0;
    const progressContainer = document.getElementById("progressContainer");
    const progressFill = document.getElementById("progressFill");
    const links = document.getElementById("links");
    
    if(percent>0 && percent<100){
      progressContainer.style.display="block"; links.style.display="none"; 
      progressFill.style.width=percent+"%";
      sendButton.disabled=true;
      sendButton.textContent = `Processing ${percent}%...`;
    } else if(percent===100){
      progressFill.style.width="100%"; 
      progressContainer.style.display="none"; // Hide bar when done
      links.style.display="flex"; // Flex column
      
      document.getElementById("playLink").href = url + data.game_link;
      document.getElementById("downloadLink").href = url + data.download_link;
      document.getElementById("downloadAnalysis").href = url + data.analysis_link;
      
      sendButton.disabled=false;
      sendButton.textContent = "Generate Code";
    } else {
      progressContainer.style.display="none"; links.style.display="none"; progressFill.style.width="0%";
    }
  })
  .catch(err=>console.error("Status error:", err));
}
setInterval(checkStatus,1000);
</script>
</body>
</html>

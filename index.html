<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Editor</title>
  <style>
    :root{--bg:#071026;--panel:#0d1420;--accent1:#6ee7b7;--accent2:#7dd3fc}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Arial;background: url('backgroundd.png') center/cover no-repeat;color:#e7f6f2}
    .container{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:18px;gap:14px}
    .header{width:100%;max-width:1200px;display:flex;justify-content:flex-end;align-items:center}
    .toolbar{display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,#0b1220,#0f1724);color:var(--accent2);cursor:pointer;font-weight:700;box-shadow:0 8px 20px rgba(2,6,23,0.6)}
    .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04221a}
    .dropdown{position:relative}
    .dropdown-content{display:none;position:absolute;top:100%;left:0;flex-direction:column;background:#0b1220;border-radius:8px;overflow:hidden;z-index:100}
    .dropdown-content button{border-radius:0;box-shadow:none;text-align:left;width:200px}
    .dropdown:hover .dropdown-content{display:flex}
    .canvasWrap{width:100%;max-width:1024px;display:flex;flex-direction:column;gap:10px}
    .canvas{width:100%;aspect-ratio:1/1;border-radius:12px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.6);background: url('layerr.png') center/cover no-repeat;}
    .grid-bg{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:24px 24px,24px 24px;pointer-events:none}
    .panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);color:#93a4b3;width:100%}
    .textarea{width:100%;height:100px;padding:8px;border-radius:8px;border:none;background:#07182a;color:#dff8ef;resize:none}
    .sendRow{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}
    .element{position:absolute;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#07121a;user-select:none;box-shadow:0 8px 20px rgba(2,6,23,0.6); overflow: hidden;text-overflow: ellipsis;white-space: nowrap;text-align: center;}
    .grid{background:linear-gradient(180deg,rgba(37,99,235,0.9),rgba(96,165,250,0.85));color:#fff}
    .play_button{background:linear-gradient(90deg,#ef4444,#fb7185);color:#fff}
    .increase_bet{background:linear-gradient(90deg,#10b981,#34d399);color:#04221a}
    .decrease_bet{background:linear-gradient(90deg,#f59e0b,#fbbf24);color:#04221a}
    .auto_play_button{background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#04221a}
    .max_bet_button{background:linear-gradient(90deg,#6366f1,#818cf8);color:#fff}
    .min_bet_button{background:linear-gradient(90deg,#84cc16,#a3e635);color:#04221a}
    .increase_level{background:linear-gradient(90deg,#ec4899,#f472b6);color:#fff}
    .decrease_level{background:linear-gradient(90deg,#ec4899,#f472b6);color:#fff}
    .sprite {background: linear-gradient(90deg, #f87171, #fca5a5);color: #031724;padding: 6px 8px;border-radius:8px}
    .win_label{background:linear-gradient(90deg,#8b5cf6,#c084fc);color:#07121a;padding:6px 10px;border-radius:8px}
    .label{background:linear-gradient(90deg,#60a5fa,#7dd3fc);color:#031724;padding:6px 8px;border-radius:8px}
    .handle{position:absolute;right:-10px;bottom:-10px;width:18px;height:18px;border-radius:6px;background:#fff;border:2px solid rgba(0,0,0,0.12);cursor:se-resize;z-index:20}
    .badge{position:absolute;transform:translate(10px,-44px);background:rgba(2,12,20,0.9);color:#bfeee1;padding:6px 8px;border-radius:8px;font-size:12px;z-index:30;pointer-events:none}
    .context{position:absolute;display:none;flex-direction:column;gap:8px;padding:10px;border-radius:8px;background:#071429;border:1px solid rgba(255,255,255,0.04);z-index:60;min-width:220px}
    .context input{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071827;color:#e6fbf6;width:100%}
    .context .row{display:flex;gap:8px;align-items:center}
    .context label{font-size:12px;color:#93a4b3;width:60px}
    .context .actions{display:flex;gap:8px;justify-content:flex-end}
    .context button{padding:8px 10px;border-radius:6px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#04221a;font-weight:800;cursor:pointer}
    .footer{width:100%;max-width:1200px;text-align:center;color:#93a4b3;font-size:13px}

    /* Progress & links */
    #waitMessage { display: none; color: #ff8080; margin-bottom: 6px; font-weight: bold; }

    #progressContainer {
      width: 100%;
      height: 10px;
      background: #333;
      margin-bottom: 6px;
      border-radius: 6px;
      overflow: hidden;
      display: none;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      transition: width 0.3s ease;
    }

    #links { display: none; margin-bottom: 6px; }
    #links a {
      color: #00f2fe;
      text-decoration: none;
      margin: 0 6px;
      font-weight: bold;
    }
    #links a:hover { text-decoration: underline; }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="toolbar">
        <button class="btn" id="addGrid">Insert Grid</button>
        <div class="dropdown">
          <button class="btn">Insert Play</button>
          <div class="dropdown-content">
            <button data-type="play_button">Play Button</button>
            <button data-type="increase_bet">Increase Bet Button</button>
            <button data-type="decrease_bet">Decrease Bet Button</button>
            <button data-type="auto_play_button">Auto Play Button</button>
            <button data-type="max_bet_button">Max Bet Button</button>
            <button data-type="min_bet_button">Min Bet Button</button>
            <button data-type="increase_level">Increase_level Button</button>
            <button data-type="decrease_level">Decrease_level Button</button>            
          </div>
        </div>
        <button class="btn" id="addWin">Insert Win</button>
        <button class="btn" id="addLabel">Insert Label</button>
        <button class="btn" id="addSprite">Insert Sprite</button>
      </div>
    </div>

    <div class="canvasWrap">
      <div id="canvas" class="canvas">
        <div class="grid-bg"></div>
      </div>
      <div class="panel">

        <div id="chatBox" style="width:100%; max-height:200px; overflow:auto; background:#111; padding:10px; border-radius:8px; color:#fff"></div>
        <textarea id="msgInput" class="textarea" placeholder="Type prompt..."></textarea>
        <div class="sendRow">
          <button class="btn primary" id="send">Send</button>
        </div>
        <div id="waitMessage">Processing...</div>
        <div id="progressContainer">
          <div id="progressFill"></div>
        </div>
        <div id="links">
          <a id="playLink" href="#" target="_blank">Play Game</a>
          <a id="downloadLink" href="#" target="_blank">Download Gmae file</a>
          <a id="downloadAnalysis" href="#" target="_blank">Download Analysis</a>
        </div>
      </div>
    </div>

    <div class="footer">Positions and sizes are scaled to 0..1024</div>
  </div>

  <div id="contextMenu" class="context">
    <div class="row"><label>x</label><input id="ctxX" type="number"/></div>
    <div class="row"><label>y</label><input id="ctxY" type="number"/></div>
    <div class="row"><label>width</label><input id="ctxW" type="number"/></div>
    <div class="row"><label>height</label><input id="ctxH" type="number"/></div>
    <div class="row" id="textRow"><label>text</label><input id="ctxText"/></div>
    <div class="actions">
      <button id="btnDelete">Delete</button>
      <button id="btnApply">Apply</button>
    </div>
  </div>
<script>
const canvas = document.getElementById('canvas');
const contextMenu = document.getElementById('contextMenu');
const url = "https://tamica-inventoriable-kimbra.ngrok-free.app";
const session_id = "user_" + Math.floor(Math.random() * 1000000);
const sendButton = document.getElementById('send');

const ctxX = document.getElementById('ctxX'),
      ctxY = document.getElementById('ctxY'),
      ctxW = document.getElementById('ctxW'),
      ctxH = document.getElementById('ctxH'),
      ctxText = document.getElementById('ctxText'),
      textRow = document.getElementById('textRow');

const elements = {
  grid: null,
  play_button: null,
  increase_bet: null,
  decrease_bet: null,
  auto_play_button: null,
  max_bet_button: null,
  min_bet_button: null,
  increase_level: null,
  decrease_level: null,  
  win_label: null,
  labels: [],
  sprites: [] 
};  

function updateFontSize(el) {
  const w = el.offsetWidth;
  const h = el.offsetHeight;
  let size = Math.min(h * 0.5, w / el.textContent.length * 1.8);
  el.style.fontSize = size + "px";
  el.style.lineHeight = h + "px";  
}

  
let current = null;
function create(type) {
  if (type !== 'label' && elements[type]) return;

  const el = document.createElement('div');
  el.className = 'element ' + (type === 'label' ? 'label' : type);
  el.style.width = '120px';
  el.style.height = '56px';
  el.style.left = '32px';
  el.style.top = '32px';
  el.dataset.type = type;

  if (type === 'label'  || type === 'sprite') {
    const span = document.createElement('span');
    span.textContent = '';
    el.appendChild(span);
  } else {
    el.textContent = type.replace(/_/g, ' ').toUpperCase();
    updateFontSize(el);
  }

  const handle = document.createElement('div');
  handle.className = 'handle';
  el.appendChild(handle);

  canvas.appendChild(el);
  if (type === 'label') elements.labels.push(el);
  else if (type === 'sprite') elements.sprites.push(el);
  else elements[type] = el;

  attach(el, handle);
}

function attach(el, handle) {
  el.addEventListener('mousedown', startDrag);
  handle.addEventListener('mousedown', startResize);
  handle.addEventListener('mouseenter', () => showBadge(el));
  handle.addEventListener('mouseleave', () => hideBadge(el));
  el.addEventListener('contextmenu', e => {
    e.preventDefault();
    current = el;
    openContext(e.pageX, e.pageY);
  });
}

function getPos(el) {
  const r = el.getBoundingClientRect(),
        p = canvas.getBoundingClientRect();
  return {
    x: Math.round(r.left - p.left),
    y: Math.round(r.top - p.top),
    width: Math.round(r.width),
    height: Math.round(r.height)
  };
}

function showBadge(el) {
  if (el._badge) return updateBadge(el);
  const b = document.createElement('div');
  b.className = 'badge';
  el._badge = b;
  el.appendChild(b);
  updateBadge(el);
}

function updateBadge(el) {
  const d = getPos(el);
  el._badge.textContent = `x=${d.x} y=${d.y} w=${d.width} h=${d.height}`;
}

function hideBadge(el) {
  if (el._badge) { el._badge.remove(); el._badge = null; }
}

function startDrag(e) {
  if (e.target.classList.contains('handle')) return;
  e.preventDefault();
  const el = this;
  const rect = el.getBoundingClientRect(),
        p = canvas.getBoundingClientRect();
  const startX = e.clientX,
        startY = e.clientY;
  const origX = rect.left - p.left,
        origY = rect.top - p.top;

  function move(ev) {
    const nx = Math.max(0, Math.min(origX + ev.clientX - startX, canvas.clientWidth - el.offsetWidth));
    const ny = Math.max(0, Math.min(origY + ev.clientY - startY, canvas.clientHeight - el.offsetHeight));
    el.style.left = nx + 'px';
    el.style.top = ny + 'px';
    if (el._badge) updateBadge(el);
  }

  function up() { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); }

  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
}

function startResize(e) {
  e.stopPropagation(); e.preventDefault();
  const el = this.parentElement;
  el._resizing = true;
  const startX = e.clientX,
        startY = e.clientY,
        startW = el.offsetWidth,
        startH = el.offsetHeight;

  function move(ev) {
    let rawLeft = parseInt(el.style.left) || el.offsetLeft;
    let rawTop = parseInt(el.style.top) || el.offsetTop;
    let nw = Math.max(24, Math.min(startW + ev.clientX - startX, canvas.clientWidth - rawLeft));
    let nh = Math.max(24, Math.min(startH + ev.clientY - startY, canvas.clientHeight - rawTop));
    el.style.width = nw + 'px';
    el.style.height = nh + 'px';
    updateFontSize(el);
    if (el._badge) updateBadge(el);
  }
  function up() { el._resizing = false; document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); }
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', up);
}
function openContext(pageX, pageY) {
  const d = getPos(current);
  ctxX.value = d.x; ctxY.value = d.y; ctxW.value = d.width; ctxH.value = d.height;
const isTextType = ['label', 'sprite'].includes(current.dataset.type);
textRow.style.display = isTextType ? 'flex' : 'none';
ctxText.value = isTextType ? current.textContent.trim() : '';
  contextMenu.style.left = pageX + 'px'; contextMenu.style.top = pageY + 'px';
  contextMenu.style.display = 'flex';
}
document.getElementById('btnApply').addEventListener('click', () => {
  if (!current) return;
  const nx = Number(ctxX.value)||0, ny = Number(ctxY.value)||0, nw = Math.max(8,Number(ctxW.value)||8), nh = Math.max(8,Number(ctxH.value)||8);
  const c = canvas.getBoundingClientRect();
  if (nx+nw>c.width || ny+nh>c.height) { alert("Values exceed 1024 boundary"); return; }
  current.style.left = nx+'px'; current.style.top = ny+'px'; current.style.width = nw+'px'; current.style.height = nh+'px';
  if(['label','sprite'].includes(current.dataset.type)){
  current.firstElementChild.textContent = ctxText.value;}
  contextMenu.style.display='none'; hideBadge(current);
});

document.getElementById('btnDelete').addEventListener('click', () => {
  if (!current) return;
  const t = current.dataset.type;
  current.remove();

  if (t === 'label') {
    const i = elements.labels.indexOf(current);
    if (i > -1) elements.labels.splice(i, 1);
  } else if (t === 'sprite') {
    const i = elements.sprites.indexOf(current);
    if (i > -1) elements.sprites.splice(i, 1);
  } else {
    elements[t] = null;
  }

  contextMenu.style.display = 'none';
});


document.addEventListener('click', e=>{if(!contextMenu.contains(e.target)) contextMenu.style.display='none';});


document.getElementById('addGrid').addEventListener('click', ()=>create('grid'));
document.querySelectorAll('.dropdown-content button').forEach(b => b.addEventListener('click', ()=>create(b.dataset.type)));
document.getElementById('addWin').addEventListener('click', ()=>create('win_label'));
document.getElementById('addLabel').addEventListener('click', ()=>create('label'));
document.getElementById('addSprite').addEventListener('click', ()=>create('sprite'));

canvas.addEventListener('mousemove', e=>{
  [...canvas.querySelectorAll('.element')].forEach(el=>{
    const rect = el.getBoundingClientRect(), hx = rect.right-12, hy = rect.bottom-12;
    const overHandle = e.clientX>=hx-12 && e.clientX<=hx+12 && e.clientY>=hy-12 && e.clientY<=hy+12;
    if(overHandle) showBadge(el); else if(!el.matches(':hover')&&!el._resizing) hideBadge(el);
  });
});




  
function collectPayload() {
  const payload = {};
  const c = canvas.getBoundingClientRect();
  function to1024(v,axis){ return Math.round(v/(axis===0?c.width:c.height)*1024); }

  for(const k in elements){
    if(k==='labels') continue;
    if(elements[k]){
      const d = getPos(elements[k]);
      payload[k] = { x:to1024(d.x,0), y:to1024(d.y,1), width:to1024(d.width,0), height:to1024(d.height,1) };
    }
  }

  payload.Labels = elements.labels.map(l=>{
    const d = getPos(l);
    return { x:to1024(d.x,0), y:to1024(d.y,1), width:to1024(d.width,0), height:to1024(d.height,1), text:l.firstElementChild?l.firstElementChild.textContent:'' };
  });


payload.Sprites = elements.sprites.map(s=>{
  const d = getPos(s);
  return { x:to1024(d.x,0), y:to1024(d.y,1), width:to1024(d.width,0), height:to1024(d.height,1), text:s.firstElementChild ? s.firstElementChild.textContent : '' };
});


  
  payload.message = document.getElementById('msgInput').value;
  return payload;
}

sendButton.addEventListener('click', ()=>{
  
  const payload = collectPayload();

  console.log("=== JSON THAT WILL BE SENT ===");
  console.log(JSON.stringify({ session_id, rects: payload }, null, 2));
  
  // document.getElementById("waitMessage").style.display="block";
  // fetch(`${url}/receive_message`, {
  //   method: "POST",
  //   headers: { "Content-Type":"application/json" },
  //   body: JSON.stringify({ session_id, rects: payload })
  // })
  // .then(res=>res.json())
  // .then(data=>{
  //   document.getElementById("waitMessage").style.display="none";
  //  if (data.status === "True") {
  // const chatBox = document.getElementById("chatBox");
  // const userMsg = document.createElement("div");
  // userMsg.textContent = "You: " + payload.message;
  // userMsg.style.marginBottom = "6px";
  // chatBox.appendChild(userMsg);
  // const botMsg = document.createElement("div");
  // botMsg.textContent = "Bot: " + data.reply;
  // botMsg.style.color = "#7dd3fc";
  // botMsg.style.marginBottom = "10px";
  // chatBox.appendChild(botMsg);
  // chatBox.scrollTop = chatBox.scrollHeight;
  // } else {
  // console.error("Error:", data.reply);
  // }
  // })
  // .catch(err=>{ console.error(err); document.getElementById("waitMessage").style.display="none"; });
});


function checkStatus(){
  fetch(`${url}/get_status`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ session_id })
  })
  .then(res=>res.json())
  .then(data=>{
    const percent = data.process_percent||0;
    const progressContainer = document.getElementById("progressContainer");
    const progressFill = document.getElementById("progressFill");
    const links = document.getElementById("links");
    if(percent>0 && percent<100){
      progressContainer.style.display="block"; links.style.display="none"; progressFill.style.width=percent+"%";
      sendButton.disabled=true;
    } else if(percent===100){
      progressFill.style.width="100%"; progressContainer.style.display="block"; links.style.display="block";
      document.getElementById("playLink").href = url + data.game_link;
      document.getElementById("downloadLink").href = url + data.download_link;
      document.getElementById("downloadAnalysis").href = url + data.analysis_link;
      const iframe=document.getElementById("gamePreview");
      if(iframe) iframe.src = url + data.game_link;
      sendButton.disabled=false;
    } else {
      progressContainer.style.display="none"; links.style.display="none"; progressFill.style.width="0%";
    }
  })
  .catch(err=>console.error("Status error:", err));
}
setInterval(checkStatus,1000);
</script>
</body>
</html>
